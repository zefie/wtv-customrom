<html>

<script src=file://ROM/JS/parameters.js></script>

<head>
	<link href="CommonStyles.css" rel=Stylesheet>

	<style>
		#writeArea {
			position: absolute;
			top: 82;
			left: 14;
			width: 418;
		}
	</style>

	<script>
window.message("WriteLetterScroll parameters.cmd = ", parameters.cmd);

		var sentMessage = false;

		function CreateUniqueMessageID()
		{
			// *** Note that the unique ID keeps on growing and growing. There's no check
			// for now to check for or force a wrap around. With a 32 bit number, maybe it's
			// impossible for anyone to send that many emails (except a super spammer). Also,
			// this code doesn't yet check for an existing outgoing message with the same id.

			var uniqueID = parseInt(top.gUserInfo.getAttribute("LastID")) + 1;
			top.gUserInfo.setAttribute("LastID", uniqueID);
			top.SaveUserAttributes();
			return uniqueID;
		}

		function RecursiveExpandNames(addresses, count)
		{
			window.message("RecursiveExpandNames addresses = " + addresses);

			if (count <= 0)			// emergency break out to prevent infinite recursion
				return addresses;

			var addressList = addresses.split(",");
			var len = addressList.length;

			var replaced = false;

			for (var i = 0; i < len; i++) {
				var nickName = addressList[i];
				var address = top.FindAddress(nickName);
		window.message("nickName = ", nickName, " address = ", address);
				if (address != "") {
					addressList[i] = address;	// replace nickname with expanded address
					replaced = true;
				}
			}
			addresses = addressList.join(",");

			if (replaced)
				addresses = RecursiveExpandNames(addresses, --count);

			return addresses;
		}

		function ExpandNicknames(addresses)
		{
			return RecursiveExpandNames(addresses, 10);	// limit recursion to 10 levels
		}

		function SendMessage()
		{
			if (document.sendform.message_to.value == "") {
				var L_NoAddress_Text = "Your message could not be sent.\n\nYou must specify an addressee in the To: area.";
				alertPriv(L_NoAddress_Text, top.gAlertIconURL, top.L_Continue_Text);
				return false;
			}
			SaveMessage();		// temporarily save field values because ValidateAddress might change the location
			var addressList = ExpandNicknames(document.sendform.message_to.value);
			if (!top.ValidateAddresses(addressList))
				return false;

			if (top.gCCMsg) {
				addressList = document.sendform.cc_to.value;
				if (addressList != "") {
					addressList = ExpandNicknames(addressList);
					if (!top.ValidateAddresses(addressList))
						return false;
				}
			}

			var L_SendMsg_Text = "Putting message in the out box.";
			window.tvSplash(L_SendMsg_Text, 1);

			var today = new Date();
			var todayText = today.toLocaleString();

			// Make sure the email isn't too big
			// First, get the size of a blank email as the base size
			// Have to make a path name compatible with the store object. Paths between
			// store and xml are not compatible.

			var blankEmail = top.newStore(top.gAppInfo.getAttribute("BlankWriteMsg"));
			var totalLen = blankEmail.data.length;
			totalLen += document.sendform.message_body.value.length;
			totalLen += document.sendform.message_to.value.length;
			totalLen += document.sendform.message_subject.value.length;
			totalLen += todayText.length;

			if (totalLen >= top.gConfig.MaxOutBoxMsgSize) {
				var L_MsgTooBig_Text = "Your message is too big to be sent. Make it smaller.";
				alertPriv(L_MsgTooBig_Text, top.gAlertIconURL, top.L_Continue_Text);
				return false;
			}

			// create XML tree with a blank email
			var blankMsgXML = top.NewXMLDocument();
			var url = "file://" + top.gPath.BlankMsgFile;
			if (blankMsgXML.load(url)) {

				var appInfos = blankMsgXML.getElementsByTagName("letter");
				var appInfo = appInfos[0];
				appInfo.setAttribute("deleted", "n");

				var messageBodies = blankMsgXML.getElementsByTagName("message");
//				messageBodies[0].firstChild.text = '<![CDATA[' + document.sendform.message_body.value + ']]>';
				messageBodies[0].firstChild.text = document.sendform.message_body.value;

				var senders = blankMsgXML.getElementsByTagName("sender_name");
				senders[0].firstChild.text = "";

				var addresses = blankMsgXML.getElementsByTagName("sender_address");
				addresses[0].firstChild.text = document.sendform.message_to.value;

				if (top.gCCMsg) {
					var ccs = blankMsgXML.getElementsByTagName("cc");
					ccs[0].firstChild.text = document.sendform.cc_to.value;
				}

				var sendDates = blankMsgXML.getElementsByTagName("send_date");
				sendDates[0].firstChild.text = todayText;

				var subjects = blankMsgXML.getElementsByTagName("subject");
				subjects[0].firstChild.text = document.sendform.message_subject.value;

				if (parameters.cmd == "forward" || ((parameters.cmd == "reply" || parameters.cmd == "replyall") && parameters.reply == "show")) {
					var letters = blankMsgXML.getElementsByTagName("letter");
					letters[0].setAttribute("forward_msgid", top.gLetter.msgid);
				}

				var uniqueID = CreateUniqueMessageID();
				appInfo.setAttribute("msgid", uniqueID);
				var filename = top.FixFilenameForXMLWriting(top.gOutFolderStore.location) + "/" + uniqueID.toString() + ".xml";

		window.message("WRITING xml to ", filename);

				blankMsgXML.toXML(filename);
				top.MailFolder_AddLetter(top.gOutFolder, blankMsgXML, filename, "top.gOutFolder");

				sentMessage = true;
			} else {
				window.message("SendMessage - couldn't load ", url);
			}
			SaveMessage();	// until onUnload works
			history.back();
		}

		function ClearFields(askConfirm)
		{
			var L_EraseMsg_Text = "Are you sure you want to erase the changes to this message?";
			var L_EraseButton_Text = "Erase";
			var L_DontEraseButton_Text = "Don't Erase";

			if (!askConfirm || confirmPriv(L_EraseMsg_Text, top.gAlertIconURL, L_EraseButton_Text, L_DontEraseButton_Text)) {
				if (parameters.cmd != "reply" && parameters.cmd != "replyall") {
					document.sendform.message_to.value = '';
				}
				if (parameters.cmd == "write") {
					document.sendform.message_subject.value = '';
				}
				// In all cases, the message is erased
				document.sendform.message_body.value = '';
			}
		}

		function SetFields()
		{
			if (parameters.cmd == "reply") {
				window.message("loading reply");
				document.sendform.message_to.value = top.gLetter.senderAddress;
				document.sendform.message_subject.value = "Re: " + top.gLetter.subject;
				document.sendform.message_body.value = top.gReplyIncludeMsg ? top.gLetter.body : "";
				if (top.gCCMsg)
					document.sendform.cc_to.value = "";
			} else if (parameters.cmd == "replyall") {
				window.message("loading reply");
				document.sendform.message_to.value = top.gLetter.senderAddress;
				document.sendform.message_subject.value = "Re: " + top.gLetter.subject;
				document.sendform.message_body.value = top.gReplyIncludeMsg ? top.gLetter.body : "";
				if (top.gCCMsg)
					document.sendform.cc_to.value = top.gEmailAddress;	// ****** we need another field in the XML msg that contains a list of addresses
			} else if (parameters.cmd == "forward") {
				window.message("loading fwd");
				document.sendform.message_to.value = top.gLetter.senderAddress;
				document.sendform.message_subject.value = "Fwd: " + top.gLetter.subject;
				document.sendform.message_body.value = "";
				if (top.gCCMsg)
					document.sendform.cc_to.value = "";
			} else {
				window.message("loading last saved message");
				// get saved values of last message write
				var filename = "file://" + top.gPath.LastMsgFile;
				if (top.xmldoc.load(filename)) {
					var addresses = top.xmldoc.getElementsByTagName("sender_address");
					if (addresses[0].firstChild != null)
						document.sendform.message_to.value = addresses[0].firstChild.text;
					else
						document.sendform.message_to.value = "";

					if (top.gCCMsg) {
						var ccs = top.xmldoc.getElementsByTagName("cc");
						if (ccs[0].firstChild != null)
							document.sendform.cc_to.value = ccs[0].firstChild.text;
						else
							document.sendform.cc_to.value = "";
					}

					var subjects = top.xmldoc.getElementsByTagName("subject");
					if (subjects[0].firstChild != null)
						document.sendform.message_subject.value = subjects[0].firstChild.text;
					else
						document.sendform.message_subject.value = "";

					var bodies = top.xmldoc.getElementsByTagName("message");
					if (bodies[0].firstChild != null)
						document.sendform.message_body.value = bodies[0].firstChild.text;
					else
						document.sendform.message_body.value = "";
				} else {
					window.message("WriteLetterScroll::SetFields - couldn't load ", filename);
				}
			}
			top.refreshArrows();
		}

		function WriteTextArea(props, selected)
		{
			document.write("<textarea ", props);
			if (selected)
				document.write(" selected");
			document.write("></textarea>");
		}

		function SaveMessage()
		{
			// Save the state of the fields so they can be restored if this isn't a reply or forward
	window.message("SaveMessage");
			var url = "file://" + top.gPath.LastMsgFile;
			if (top.xmldoc.load(url)) {

				var messageText = document.sendform.message_body.value != null && !sentMessage ? document.sendform.message_body.value : "";
window.message("sentMessage ", sentMessage, " messageText ", messageText);
				var messageBodies = top.xmldoc.getElementsByTagName("message");
				if (messageBodies[0].firstChild == null) {
					if (messageText != "") {
						var textNode = top.xmldoc.createTextNode(messageText);
						messageBodies[0].appendChild(textNode);
					}
				} else
					messageBodies[0].firstChild.text = messageText;

				var toText = document.sendform.message_to.value != null && !sentMessage  ? document.sendform.message_to.value : "";
				var addresses = top.xmldoc.getElementsByTagName("sender_address");
				if (addresses[0].firstChild == null) {
					if (toText != "") {
						var textNode = top.xmldoc.createTextNode(toText);
						addresses[0].appendChild(textNode);
					}
				} else
					addresses[0].firstChild.text = toText;

				var ccText = document.sendform.cc_to.value != null && !sentMessage  ? document.sendform.cc_to.value : "";
				var ccs = top.xmldoc.getElementsByTagName("cc");
				if (ccs[0].firstChild == null) {
					if (ccText != "") {
						var textNode = top.xmldoc.createTextNode(ccText);
						ccs[0].appendChild(textNode);
					}
				} else
					ccs[0].firstChild.text = ccText;

				var subjectText = document.sendform.message_subject.value != null && !sentMessage  ? document.sendform.message_subject.value : "";
				var subjects = top.xmldoc.getElementsByTagName("subject");
				if (subjects[0].firstChild == null) {
					if (subjectText != "") {
						var textNode = top.xmldoc.createTextNode(subjectText);
						subjects[0].appendChild(textNode);
					}
				} else
					subjects[0].firstChild.text = subjectText;

				var filename = top.gPath.LastMsgFile;
	window.message("Saving Write params to ", filename);
				top.xmldoc.toXML(filename);
			}
		}

		function WriteSeparator()
		{
			var s  = '<td colspan=2 absheight=3>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=3></td>';
			s += '	</tr>';
			s += '	<tr absheight=4>';
			s += '		<td colspan=2>';
			s += '			<img src=images/DottedLine.gif width=386 height=2></td>';
			s += '	</tr>';
			s += '	<tr>';
			s += '		<td colspan=2 absheight=3>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=3></td>';
			s += '	</tr>';
			document.write(s);
		}

		function ToggleReply()
		{
			var reply = parameters.reply == "show" ? "hide" : "show";
			parent.location = "WriteLetter.html?cmd=reply&reply=" + reply;

			return true;	// if it does return, that is :-)
		}

	</script>

	<title>
		Write a message
	</title>

</head>

<print blackandwhite>

<body
	text=42BD52
	link=189CD6
	vlink=189CD6
	vspace=0
	hspace=0
	bgcolor=172625
	fontsize=medium
	onUnload="SaveMessage();"
	onLoad="SetFields();"
	>

<div id=topBannerBackgroundScroll bgcolor=0c1413 gradcolor=172625 gradangle=0>
</div>

<div id=topBannerScroll>
	<img src=images/MailBanner.gif width=431 height=54>
</div>

<div id=pageTitleTextScroll>
	<shadow>Write a message</shadow>
</div>

<div id=bannerAdDisplay>
	<table cellspacing=0 cellpadding=0>
		<tr><td align=center bgcolor=000000>
			<script>
				 if (top.clientVersion() >= 3)
					 top.WriteAd("epg-banner");
			</script>

	</table>
</div>

<div id=writeArea>
	<form name=sendform>
		<script>
			s  = '<img src=images/PageTopCurl.gif bgcolor=0 noprint width=418 height=32>';
			s += '<table cellspacing=0 cellpadding=0 bgcolor=1c2e2d background="">';
			s += '	<tr>';
			s += '		<td rowspan=100 abswidth=2 absheight=0 bgcolor=2c4847>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=1></td>';
			s += '		<td rowspan=100 abswidth=14 absheight=0>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=1></td>';
			s += '		<td colspan=2 abswidth=386></td>';
			s += '		<td rowspan=100 abswidth=14 absheight=0>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=1></td>';
			s += '		<td rowspan=100 abswidth=6 bgcolor=0b0b0b absheight=0>';
			s += '			<img src=images/TransVertShadow.gif width=6 height=1></td>';
			s += '</tr>';
			s += '<tr absheight=30>';
			s += '	<td abswidth=72 valign=center align=left bgcolor=48775d>';
			s += '			<font size=-2 color=0f1918>&nbsp<b>FROM</b></font>';
			s += '		</td>';
			s += '		<td abswidth=306>';
			s += '			<font color=cbcbcb>&nbsp';
			s += top.gEmailAddress;
			if (top.gUserName != "")
				s += " (" + top.gUserName + ")";
			s += '			</font>';
			s += '		</td>';
			s += '	</tr>';
			document.write(s);
			WriteSeparator();
			s  = '	<tr height=30>';
			s += '		<td abswidth=72 valign=center align=left bgcolor=48775d>';
			s += '			<a href="client:openaddresspanel?name=' + top.gEmailAddress + '">';
			s += '			<font size=-2 color=0f1918>&nbsp<b>TO</b></font>';
			s += '			</a></td>';
			s += '		<td abswidth=306>';
			document.write(s);
			WriteTextArea('bgcolor=1c2e2d cursor=#cc9933 nosoftbreaks '
				+ 'borderimage="file://ROM/Borders/textfield.alt1.bif" '
				+ 'nohardbreaks font=proportional text=cbcbcb '
				+ 'name="message_to" border=0 width=306 rows=1 growable '
				+ 'autoactivate addresses autoascii nohighlight ', 
				parameters.cmd == "write" || parameters.cmd == "forward" );
			s  = '		</td>';
			s += '	</tr>';
			document.write(s);
			WriteSeparator();

			if (top.gCCMsg) {
				s  = '	<tr height=30>';
				s += '		<td abswidth=72 valign=center align=left bgcolor=48775d>';
				s += '			<a href="client:openaddresspanel?name=' + top.gEmailAddress + '">';
				s += '			<font size=-2 color=0f1918>&nbsp<b>CC</b></font>';
				s += '			</a></td>';
				s += '		<td abswidth=306>';
				document.write(s);
				WriteTextArea('bgcolor=1c2e2d cursor=#cc9933 nosoftbreaks '
					+ 'borderimage="file://ROM/Borders/textfield.alt1.bif" '
					+ 'nohardbreaks font=proportional text=cbcbcb '
					+ 'name="cc_to" border=0 width=306 rows=1 growable '
					+ 'autoactivate addresses autoascii nohighlight ', 
					false);
				s  = '		</td>';
				s += '	</tr>';
				document.write(s);
				WriteSeparator();
			}

			s  = '	<tr height=30>';
			s += '		<td abswidth=72 valign=center align=left nowrap bgcolor=48775d>';
			s += '			<font size=-2 color=0f1918>&nbsp<b>SUBJECT</b></font>';
			s += '		</td>';
			s += '		<td abswidth=306>';
			document.write(s);
			WriteTextArea('bgcolor=1c2e2d cursor=#cc9933 nosoftbreaks '
				+ 'borderimage="file://ROM/Borders/textfield.alt1.bif" '
				+ 'nohardbreaks text=cbcbcb name="message_subject" font=proportional '
				+ 'border=0 width=306 rows=1 growable autoactivate '
				+ 'maxlength=70 nohighlight autohiragana ', 
				false);
			s  = '			</td>';
			s += '	</tr>';
			document.write(s);
			WriteSeparator();
			s  = '	<tr>';
			s += '		<td colspan=2 absheight=10>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=10></td>';
			s += '	</tr>';
			s += '	<tr>';
			s += '		<td colspan=2 abswidth=386 !!xabswidth=386>';
			document.write(s);
			WriteTextArea('nosoftbreaks bgcolor=1c2e2d text=cbcbcb '
				+ 'cursor=#cc9933 name="message_body" font=proportional '
				+ 'border=0 rows=' + (top.gCCMsg ? 3 : 4) + ' width=386 nohighlight '
				+ 'autoactivate autohiragana growable ', 
				parameters.cmd == "reply");
			s  = '		</td>';
			s += '	</tr>';
			s += '	<tr>';
			s += '		<td colspan=2 absheight=8>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=8></td>';
			s += '	</tr>';
			s += '</table>';

			s += '<table cellspacing=0 cellpadding=0>';
			s += '	<tr>';
			s += '		<td rowspan=100 abswidth=10>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=10 height=2></td>';
			s += '	</tr>';
			s += '		<td abswidth=422>';
			s += '			<img src=images/PageBottom.gif noprint width=422 height=6></td>';
			s += '	</tr>';
			s += '	<tr>';
			s += '		<td absheight=6>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=6></td>';
			s += '	</tr>';
			s += '</table>';

			s += '<table cellspacing=0 cellpadding=0>';
			s += '	<tr>';
			s += '		<td abswidth=426 align=right>';
			s += '			<font size=-1 color=#ffcf69><shadow>';
			s += '			<input type=submit value=Done name=Done';
			s += '				usestyle width=137 action="" onClick=\'SendMessage();\'';
			s += '				borderimage=file://ROM/tvimages/TVButtonBorder.bif>';
			s += '			</shadow></font>';
			s += '		</td>';
			s += '	</tr>';
			s += '	<tr>';
			s += '		<td absheight=10>';
			s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=10></td>';
			s += '	</tr>';
			s += '</table>';
			document.write(s);

			if (parameters.cmd == "forward" || (parameters.cmd == "reply" && parameters.reply == "show")) {
				var L_ReplyMsg_Text = "Original message:";
				var L_FwdMsg_Text = "Forwarded message:";

				s  = '<img src=images/PageTopCurl.gif bgcolor=0 noprint width=418 height=32>';
				s += '<table cellspacing=0 cellpadding=0 bgcolor=1c2e2d background="">';
				s += '	<tr>';
				s += '		<td rowspan=100 abswidth=2 absheight=0 bgcolor=2c4847>';
				s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=1></td>';
				s += '		<td rowspan=100 abswidth=14 absheight=0>';
				s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=1></td>';
				s += '		<td colspan=2 abswidth=386></td>';
				s += '		<td rowspan=100 abswidth=14 absheight=0>';
				s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=1></td>';
				s += '		<td rowspan=100 abswidth=6 bgcolor=0b0b0b absheight=0>';
				s += '			<img src=images/TransVertShadow.gif width=6 height=1></td>';
				s += '</tr>';

				s += '<tr>';
				s += '		<td valign=middle height=40>';
				s += '			<font size=-1 color=#ffcf69>';
				s +=				parameters.cmd == "forward" ? L_FwdMsg_Text : L_ReplyMsg_Text;
				s +=			'</font><br><br>';
				if (parameters.cmd == "reply" && parameters.reply == "show") {
					s += '		<td valign=middle align=right>';
					s += '			<a onClick="ToggleReply();"';
					s += '			id=focus><font color=#ffcf69>';
					s += '			&nbsp;Detach&nbsp;</font><img src=images/RemoveButton.gif align=absmiddle height=25 width=25></a>';
				}
				s += '</tr>';

				s += '<tr absheight=30>';
				s += '	<td abswidth=72 valign=center align=left bgcolor=48775d>';
				s += '			<font size=-2 color=0f1918>&nbsp<b>FROM</b></font>';
				s += '		</td>';
				s += '		<td abswidth=306>';
				s += '			<font color=cbcbcb>&nbsp';
				s += top.gLetter.senderAddress + " (" + top.gLetter.senderName +")";
				s += '			</font>';
				s += '		</td>';
				s += '	</tr>';
				document.write(s);
				WriteSeparator();
				s  = '	<tr height=30>';
				s += '		<td abswidth=72 valign=center align=left bgcolor=48775d>';
				s += '			<a href="client:openaddresspanel">';
				s += '			<font size=-2 color=0f1918>&nbsp<b>TO</b></font>';
				s += '			</a></td>';
				s += '		<td abswidth=306>';
				s += '			<font color=cbcbcb>&nbsp';
				s += top.gEmailAddress;
				if (top.gUserName != "")
					s += " (" + top.gUserName + ")";
				s += '			</font>';
				s += '		</td>';
				s += '	</tr>';
				document.write(s);
				WriteSeparator();
				s  = '	<tr height=30>';
				s += '		<td abswidth=72 valign=center align=left nowrap bgcolor=48775d>';
				s += '			<font size=-2 color=0f1918>&nbsp<b>SUBJECT</b></font>';
				s += '		</td>';
				s += '		<td abswidth=306>';
				s += '			<font color=cbcbcb>&nbsp';
				s +=				top.gLetter.subject;
				s += '			</font>';
				s += '		</td>';
				s += '	</tr>';
				document.write(s);
				WriteSeparator();
				s  = '	<tr>';
				s += '		<td colspan=2 absheight=10>';
				s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=10></td>';
				s += '	</tr>';
				s += '	<tr>';
				s += '		<td colspan=2 abswidth=386 !!xabswidth=386>';
				s += '			<font color=cbcbcb>';
				s +=				top.gLetter.body;
				s += '			</font>';
				s += '		</td>';
				s += '	</tr>';
				s += '	<tr>';
				s += '		<td colspan=2 absheight=8>';
				s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=8></td>';
				s += '	</tr>';
				s += '</table>';

				s += '<table cellspacing=0 cellpadding=0>';
				s += '	<tr>';
				s += '		<td rowspan=100 abswidth=10>';
				s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=10 height=2></td>';
				s += '	</tr>';
				s += '		<td abswidth=422>';
				s += '			<img src=images/PageBottom.gif noprint width=422 height=6></td>';
				s += '	</tr>';
				s += '	<tr>';
				s += '		<td absheight=6>';
				s += '			<img src="wtv-home:/ROMCache/Spacer.gif" width=1 height=6></td>';
				s += '	</tr>';
				s += '</table>';
				document.write(s);
			}
			if (parameters.cmd == "reply" && parameters.reply == "hide") {
				s  = '<a onClick="ToggleReply();">'
				s += '<img src=images/RemoveButton.gif align=absmiddle height=25 width=25><font color=#ffcf69>&nbsp;Attach original message&nbsp;</font></a>'
				document.write(s);
			}
		</script>
	</form>
</div>
</body>
</html>