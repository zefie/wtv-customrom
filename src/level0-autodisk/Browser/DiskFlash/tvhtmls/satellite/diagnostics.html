<html>
<head>
<title>
Diagnostics
</title>
<DISPLAY noscroll nologo nooptions noreconnectalert>

<script language="JavaScript">

// mutex to keep the test functions from stepping on one another's toes. 
// -1  : not set
//  0  : testing phone
//  1  : testing satellite
//  2  : testing unit
var mutex = -1;

function releaseMutex() { mutex = -1; }

// 0 if mutex is clear, 1 otherwise
function checkMutex() { return mutex<0 ? 0 : 1; }

// returns 0 if mutex was taken, 1 if it managed to get it.
function takeMutex(whichTest) 
{
  if (!checkMutex())
    {
      mutex = whichTest;
      return 1;
    }
  else
    return 0;
} 

function setupScreen()
{
  mutex = -1;
  document.diagForm.phoneStatus.value = "";
  document.diagForm.satelliteStatus.value = "";
  document.diagForm.unitStatus.value = "";  
  document.diagForm.keyStatus.value = "";
} 

	function testPhone()
	{
	  var status = "Testing...";	  
	  document.diagForm.phoneStatus.value = status;

	  if (!takeMutex(0))
	    {
	      if (mutex != 0)
		setTimeout(testPhone, 1000);
	      return;
	    }
	  
	  Satellite.enablePhoneLineCheck(true);
	  setTimeout(checkPhoneStatus, 1000);
	}

	function checkPhoneStatus()
	{
		var result;
			
		result = Satellite.getPhoneLineCheckStatus();

		if (result == 0)
			setTimeout(checkPhoneStatus, 1000);
		else {
			if (result == 1)
				document.diagForm.phoneStatus.value = "OK";
			else
				document.diagForm.phoneStatus.value = "Failed";

			Satellite.enablePhoneLineCheck(false);
			releaseMutex();
		}
	}

	function testSatellite()
	{
	  var status = "Testing...";
	  document.diagForm.satelliteStatus.value = status;

	  if (!takeMutex(1))
	    {
	      if (mutex != 1)
			setTimeout(testSatellite, 1000);
	      return;	      
	    }
	  
	  setTimeout(checkSatelliteStatus, 1000);
	}

	function checkSatelliteStatus()
	{
		var result;
			
		for (i = 0; i < 40; i++) {
			result = Satellite.getSatelliteTest;
			if (result == 0)
				break;
		}

		if (result == 0)
			document.diagForm.satelliteStatus.value = "Failed";
		else
			document.diagForm.satelliteStatus.value = "OK";
		releaseMutex();
	}

	function testUnit()
	{
	  var status = "Testing...";	
	  document.diagForm.unitStatus.value = status;

	  if (!takeMutex(2))
	    {
	      if (mutex != 2)
		setTimeout(testUnit, 1000);
	      return;	      
	    }
	  
	  Satellite.enableSatUnitTest(true);
	  setTimeout(checkUnitStatus, 1000);
	}

	function checkUnitStatus()
	{
		var result;
			
		result = Satellite.getSatUnitTestStatus();

		if (result == 0)
		  {
		    setTimeout(checkUnitStatus, 1000);
		    return;
		  }
		else if (result == 1)
			document.diagForm.unitStatus.value = "OK";
		else if (result == 2)
			document.diagForm.unitStatus.value = "VRAM error";
		else if (result == 3)
			document.diagForm.unitStatus.value = "DRAM error";
		else if (result == 4)
			document.diagForm.unitStatus.value = "9110 error";
		else if (result == 5)
			document.diagForm.unitStatus.value = "Unknown error";

		Satellite.enableSatUnitTest(false);
		releaseMutex();
	}

	function testKeys()
	{
		var status = "Press key...";

		document.diagForm.keyStatus.value = status;
		setTimeout(checkKeyStatus, 1000);
	}

	function checkKeyStatus()
	{
		document.diagForm.keyStatus.value = document.lastInputKeyCode;
		setTimeout(checkKeyStatus, 200);
	}

</script>

</head>

<style type="text/css">

#banner {
	position: absolute;
	top: 0;
	left: 1;
	width: 560;
	height: 80;
}

#title {
	position: absolute;
	top: 107;
	left: 60;
	width: 400;
	height: 26;
}

#info {
	position: absolute;
	top: 147;
	left: 60;
	width: 198;
	height: 215;
}

#diagTable {
	position: absolute;
	top: 147;
	left: 285;
	width: 236;
	height: 197;
}

#phoneStatusArea {
	position: absolute;
	top: 148;
	left: 410;
	width: 236;
	height: 197;
}

#satelliteStatusArea {
	position: absolute;
	top: 182;
	left: 410;
	width: 236;
	height: 197;
}

#unitStatusArea {
	position: absolute;
	top: 216;
	left: 410;
	width: 236;
	height: 197;
}

#keyStatusArea {
	position: absolute;
	top: 250;
	left: 470;
	width: 236;
	height: 197;
}

#donebutton {
	position: absolute;
	top: 371;
	left: 410;
	width: 130;
	height: 35;
}

#MSNLogo {
	position: absolute;
	top: 7;
	left: 10;
	width: 87;
}
</style>
<body bgcolor=#21212e background="file://rom/tvimages/Pattern_TVSettings.gif" text=#6cb18a link=#6cb18a hspace=0 vspace=0 fontsize=large noscroll hideoptions onLoad="setupScreen();">

<form name=diagForm action=client:ClearTests>

	<input type=hidden name=autosubmit value=true autosubmit=onleave>

	<div id=banner>
	<table cellspacing=0 cellpadding=0 cellborder=0>
		<tr><td background="file://rom/tvimages/ShadowLogo_Horizontal.gif" width=104 height=80 valign=top align=left>
				<spacer type=block WIDTH=11 HEIGHT=11><br>
				<spacer type=block WIDTH=10 HEIGHT=1>
	    		<a href="client:showtvhome"><div id=MSNLogo><img src="file://ROM/tvimages/WebTVPlusJewelLogo.gif" ></div></a>
			<td width=456 height=80 valign=top align=center>
				<img src="file://rom/tvimages/TVSettingsBanner.gif" width=456 height=50><br>
				<img src="file://rom/tvimages/Shadow_Horizontal.gif" width=456 height=6>
	</table>
	</div>
	<div id=title>
		<font size=+2 color=#ffcf69>Diagnostics</font>
	</div>

	<div id=info>
		<font size=-1 color=989898>
		Choose a diagnostic test to run.
	</div>

	<div id=diagTable>
		<table cellspacing=0 cellpadding=0>
			<tr><td valign=top width=8>
				<img src=file://rom/tvimages/Arrow_Green.gif width=7 height=13>
				<td width=5>
				<td>
				<table cellspacing=0 cellpadding=0 href=client:donothing onclick="testPhone();">
				<tr><td align=left><font size=-1><b>Phone</b>
				</table>

			<tr><td height=16>
			<tr><td valign=top width=8>

			<tr><td valign=top width=8>
				<img src=file://rom/tvimages/Arrow_Green.gif width=7 height=13>
				<td width=5>
				<td>
				<table cellspacing=0 cellpadding=0 href=client:donothing onclick="testSatellite();">
				<tr><td align=left><font size=-1><b>Satellite</b>
				</table>

			<tr><td height=16>
			<tr><td valign=top width=8>

			<tr><td valign=top width=8>
				<img src=file://rom/tvimages/Arrow_Green.gif width=7 height=13>
				<td width=5>
				<td>
				<table cellspacing=0 cellpadding=0 href=client:donothing onclick="testUnit();">
				<tr><td align=left><font size=-1><b>Main unit</b>
				</table>

			<tr><td height=16>
			<tr><td valign=top width=8>

			<tr><td valign=top width=8>
				<img src=file://rom/tvimages/Arrow_Green.gif width=7 height=13>
				<td width=5>
				<td>
				<table cellspacing=0 cellpadding=0 href=client:donothing onclick="testKeys();">
				<tr><td align=left><font size=-1><b>Remote / Keyboard</b>
				</table>

			<tr><td height=16>
			<tr><td valign=top width=8>

			<tr><td valign=top width=8>
				<img src=file://rom/tvimages/Arrow_Green.gif width=7 height=13>
				<td width=5>
				<td>
				<table cellspacing=0 cellpadding=0 href=file://ROM/tvhtmls/satellite/satInfo.html>
				<tr><td align=left><font size=-1><b>Receiver info</b>
				</table>
		</table>
	</div>

	<div id=phoneStatusArea>
		<font size=-2 color=7399e5>
		<textarea id=phoneStatus ROWS=1 width=240 nobackground border=0 nocursor noselect usestyle></textarea>
		</font>
	</div>

	<div id=satelliteStatusArea>
		<font size=-2 color=7399e5>
		<textarea id=satelliteStatus ROWS=1 width=240 nobackground border=0 nocursor noselect usestyle></textarea>
		</font>
	</div>

	<div id=unitStatusArea>
		<font size=-2 color=7399e5>
		<textarea id=unitStatus ROWS=1 width=240 nobackground border=0 nocursor noselect usestyle></textarea>
		</font>
	</div>

	<div id=keyStatusArea>
		<font size=-2 color=7399e5>
		<textarea id=keyStatus ROWS=1 width=240 nobackground border=0 nocursor noselect usestyle></textarea>
		</font>
	</div>

	<div id=donebutton>
		<font size=-1 color=#ffcf69><shadow>
			<input selected type=submit value=Done name=Done usestyle width=130 action=client:goback
			 borderimage=file://ROM/tvimages/TVButtonBorder.bif>
		</shadow></font>
	</div>


</form>
</BODY>
</HTML>
